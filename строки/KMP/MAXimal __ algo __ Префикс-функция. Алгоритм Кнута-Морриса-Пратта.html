<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0037)http://e-maxx.ru/algo/prefix_function -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"><title>MAXimal :: algo :: Префикс-функция. Алгоритм Кнута-Морриса-Пратта</title><meta name="author" lang="ru" content="e-maxx"><meta name="description" content="Алгоритмы, олимпиадное программирование, математика"><meta name="keywords" content="алгоритмы программирование"><link rel="stylesheet" type="text/css" href="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/style.css"><script type="text/javascript" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/jquery.js"></script><script type="text/javascript" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/page-contents.js"></script><link rel="stylesheet" type="text/css" href="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/geshi.css"><!--[if IE]><style>.menu a, .menu a:hover { width: 100%; }</style><![endif]--><script type="text/javascript" async="" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/embed.js"></script></head><body><table class="main" cellpadding="0" cellspacing="0"><tbody><tr><td class="title" colspan="2"><p>MAXimal</p></td></tr><tr><td class="menu"><ul><li><a href="http://e-maxx.ru/index.php">home</a></li><li><a href="http://e-maxx.ru/algo/" class="current">algo</a></li><li><a href="http://e-maxx.ru/bookz/">bookz</a></li><li><a href="http://e-maxx.ru/forum/">forum</a></li><li><a href="http://e-maxx.ru/about.php">about</a></li></ul></td><td class="content"><p class="algoinfo">добавлено: 11 Jun 2008 10:36<br>редактировано: 4 May 2012 20:32</p><div id="contents-table"><p id="contents-table-title">Содержание <a href="http://e-maxx.ru/algo/prefix_function#" id="contents-hide">[скрыть]</a><a href="http://e-maxx.ru/algo/prefix_function#" id="contents-show" style="display:none">[показать]</a></p><div><ul><li><a href="http://e-maxx.ru/algo/prefix_function#0"> Префикс-функция. Алгоритм Кнута-Морриса-Пратта </a></li><ul><li><a href="http://e-maxx.ru/algo/prefix_function#1"> Префикс-функция. Определение </a></li><li><a href="http://e-maxx.ru/algo/prefix_function#2"> Тривиальный алгоритм </a></li><li><a href="http://e-maxx.ru/algo/prefix_function#3"> Эффективный алгоритм </a></li><ul><li><a href="http://e-maxx.ru/algo/prefix_function#4"> Первая оптимизация </a></li><li><a href="http://e-maxx.ru/algo/prefix_function#5"> Вторая оптимизация </a></li><li><a href="http://e-maxx.ru/algo/prefix_function#6"> Итоговый алгоритм </a></li><li><a href="http://e-maxx.ru/algo/prefix_function#7"> Реализация </a></li></ul><li><a href="http://e-maxx.ru/algo/prefix_function#8"> Применения </a></li><ul><li><a href="http://e-maxx.ru/algo/prefix_function#9"> Поиск подстроки в строке. Алгоритм Кнута-Морриса-Пратта </a></li><li><a href="http://e-maxx.ru/algo/prefix_function#10"> Подсчёт числа вхождений каждого префикса </a></li><li><a href="http://e-maxx.ru/algo/prefix_function#11"> Количество различных подстрок в строке </a></li><li><a href="http://e-maxx.ru/algo/prefix_function#12"> Сжатие строки </a></li><li><a href="http://e-maxx.ru/algo/prefix_function#13"> Построение автомата по префикс-функции </a></li></ul><li><a href="http://e-maxx.ru/algo/prefix_function#14"> Задачи в online judges </a></li></ul></ul></div></div><a name="0"></a><h1 id="header_0"> Префикс-функция. Алгоритм Кнута-Морриса-Пратта </h1><p></p><p></p><a name="1"></a><h2 style="padding-top:40px;" id="header_1"> Префикс-функция. Определение </h2><p>Дана строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/0697d6e9689fa1f0f0cf71d3a81c61e0.png" alt="s[0 \ldots n-1]">. Требуется вычислить для неё префикс-функцию, т.е. массив чисел <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/a7d6eaeb007c01c09070e0eb5269d98b.png" alt="\pi[0 \ldots n-1]">, где <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]"> определяется следующим образом: это такая наибольшая длина наибольшего собственного суффикса подстроки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/495fda7ff891ae7a249da7300ded14c8.png" alt="s[0 \ldots i]">, совпадающего с её префиксом (собственный суффикс — значит не совпадающий со всей строкой). В частности, значение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/315323d7df41ef0fa08b8c392acc2bd8.png" alt="\pi[0]"> полагается равным нулю.</p><p>Математически определение префикс-функции можно записать следующим образом:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8fedb60be42003853d647891b7e558aa.png" alt=" \pi[i] = \max_{k=0 \ldots i} ~ \{ ~ k ~ : ~ s[0 \[...]"></p><p>Например, для строки "abcabcd" префикс-функция равна: <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/5b5d66dc2fe59e5bb6b6bd30c95368cb.png" alt="[0, 0, 0, 1, 2, 3, 0]">, что означает:</p><ul><li>у строки "a" нет нетривиального префикса, совпадающего с суффиксом;</li><li>у строки "ab" нет нетривиального префикса, совпадающего с суффиксом;</li><li>у строки "abc" нет нетривиального префикса, совпадающего с суффиксом;</li><li>у строки "abca" префикс длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/1737ac55fdbc871d8c7d14245b749ccd.png" alt="1"> совпадает с суффиксом;</li><li>у строки "abcab" префикс длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/1f68ec6d6ed94148fc6fb5efafc8a688.png" alt="2"> совпадает с суффиксом;</li><li>у строки "abcabc" префикс длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/0e96f2a3dff7da2f31d78c5306207a14.png" alt="3"> совпадает с суффиксом;</li><li>у строки "abcabcd" нет нетривиального префикса, совпадающего с суффиксом.</li></ul><p>Другой пример — для строки "aabaaab" она равна: <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/225e60baf82eef529b919ed54964ddd0.png" alt="[0, 1, 0, 1, 2, 2, 3]">.</p><p></p><p></p><a name="2"></a><h2 style="padding-top:40px;" id="header_2"> Тривиальный алгоритм </h2><p>Непосредственно следуя определению, можно написать такой алгоритм вычисления префикс-функции:</p><p></p><pre class="notranslate cpp">vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> prefix_function <span class="br0">(</span>string s<span class="br0">)</span> <span class="br0">{</span>
	<span class="kw4">int</span> n <span class="sy1">=</span> <span class="br0">(</span><span class="kw4">int</span><span class="br0">)</span> s.<span class="me1">length</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
	vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> pi <span class="br0">(</span>n<span class="br0">)</span><span class="sy4">;</span>
	<span class="kw1">for</span> <span class="br0">(</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>n<span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">)</span>
		<span class="kw1">for</span> <span class="br0">(</span><span class="kw4">int</span> k<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> k<span class="sy1">&lt;=</span>i<span class="sy4">;</span> <span class="sy2">++</span>k<span class="br0">)</span>
			<span class="kw1">if</span> <span class="br0">(</span>s.<span class="me1">substr</span><span class="br0">(</span><span class="nu0">0</span>,k<span class="br0">)</span> <span class="sy1">==</span> s.<span class="me1">substr</span><span class="br0">(</span>i<span class="sy2">-</span>k<span class="sy2">+</span><span class="nu0">1</span>,k<span class="br0">)</span><span class="br0">)</span>
				pi<span class="br0">[</span>i<span class="br0">]</span> <span class="sy1">=</span> k<span class="sy4">;</span>
	<span class="kw1">return</span> pi<span class="sy4">;</span>
<span class="br0">}</span></pre><p>Как нетрудно заметить, работать он будет за <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/5333bf52919bd2805f33a181851ebbf4.png" alt="O(n^3)">, что слишком медленно.</p><p></p><p></p><a name="3"></a><h2 style="padding-top:40px;" id="header_3"> Эффективный алгоритм </h2><p>Этот алгоритм был разработан Кнутом (Knuth) и Праттом (Pratt) и независимо от них Моррисом (Morris) в 1977 г. (как основной элемент для алгоритма поиска подстроки в строке).</p><p></p><a name="4"></a><h3 style="padding-top:15px;" id="header_4"> Первая оптимизация </h3><p>Первое важное замечание — что значение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/ad9ddefe9651a0b778f82ce1e96b5439.png" alt="\pi[i+1]"> не более чем на единицу превосходит значение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]"> для любого <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i">.</p><p>Действительно, в противном случае, если бы <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/1bbe87f0eeff059cee20b94ccb70e23d.png" alt="\pi[i+1] &gt; \pi[i] + 1">, то рассмотрим этот суффикс, оканчивающийся в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/4ec332d2c63d7695c3b676e8e6dd9881.png" alt="i+1"> и имеющий длину <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/ad9ddefe9651a0b778f82ce1e96b5439.png" alt="\pi[i+1]"> — удалив из него последний символ, мы получим суффикс, оканчивающийся в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> и имеющий длину <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/b7b793dadcd759d55c62d897adb2d3dc.png" alt="\pi[i+1]-1">, что лучше <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]">, т.е. пришли к противоречию. Иллюстрация этого противоречия (в этом примере <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/e496c67efb860e0dbf00690e94890eff.png" alt="\pi[i-1]"> должно быть равно 3):</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/dad551a72349825ad3a09f9bdec36b7b.png" alt=" \underbrace{ \overbrace{s_0 \ s_1}^{\pi[i-1]=2} \[...]"></p><p>(на этой схеме верхние фигурные скобки обозначают две одинаковые подстроки длины 2, нижние фигурные скобки — две одинаковые подстроки длины 4)</p><p>Таким образом, при переходе к следующей позиции очередной элемент префикс-функции мог либо увеличиться на единицу, либо не измениться, либо уменьшиться на какую-либо величину. Уже этот факт позволяет нам снизить асимптотику до <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/712c5a4a9bec3c435e92314194c99f95.png" alt="O(n^2)"> — поскольку за один шаг значение могло вырасти максимум на единицу, то суммарно для всей строки могло произойти максимум <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> увеличений на единицу, и, как следствие (т.к. значение никогда не могло стать меньше нуля), максимум <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> уменьшений. В итоге получится <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/3bd5ae6ef1beefce202e062967bc49c1.png" alt="O(n)"> сравнений строк, т.е. мы уже достигли асимптотики <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/712c5a4a9bec3c435e92314194c99f95.png" alt="O(n^2)">.</p><p></p><a name="5"></a><h3 style="padding-top:15px;" id="header_5"> Вторая оптимизация </h3><p>Пойдём дальше — <b>избавимся от явных сравнений подстрок</b>. Для этого постараемся максимально использовать информацию, вычисленную на предыдущих шагах.</p><p>Итак, пусть мы вычислили значение префикс-функции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]"> для некоторого <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i">. Теперь, если <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/03f6b9c095006960fb11e43cd2acf550.png" alt="s[i+1] = s[\pi[i]]">, то мы можем с уверенностью сказать, что <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/5fc7e992dba0f81b74cb4dd9bfdfa907.png" alt="\pi[i+1] = \pi[i] + 1">, это иллюстрирует схема:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f146159fbb9ea77899d03da4573d18e2.png" alt=" \underbrace{ \overbrace{s_0 \ s_1 \ s_2}^{\pi[i]}[...]"></p><p>(на этой схеме снова одинаковые фигурные скобки обозначают одинаковые подстроки)</p><p>Пусть теперь, наоборот, оказалось, что <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/1eb195efdadd56981ad50518eb4c1a73.png" alt="s[i+1] \ne s[\pi[i]]">. Тогда нам надо попытаться попробовать подстроку меньшей длины. В целях оптимизации хотелось бы сразу перейти к такой (наибольшей) длине <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/eab58c98ab78e03ed5d6c4753a6899f9.png" alt="j &lt; \pi[i]">, что по-прежнему выполняется префикс-свойство в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i">, т.е. <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/35b64062a499937e5bb8da72d9f74232.png" alt="s[0 \ldots j-1] = s[i-j+1 \ldots i]">:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8c267f158d291598e8b8e75d9f5964ff.png" alt=" \overbrace{\underbrace{s_0 \ s_1}_{j} \ s_2 \ s_3[...]"></p><p>Действительно, когда мы найдём такую длину <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j">, то нам будет снова достаточно сравнить символы <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/efd80bbf2b7ffbd2567a2fd07b32f3ff.png" alt="s[i+1]"> и <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/6989ece3ad295d18904612384b74598e.png" alt="s[j]"> — если они совпадут, то можно утверждать, что <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f47760c52fad3dfabb25bbfb81846316.png" alt="\pi[i+1] = j+1">. Иначе нам надо будет снова найти меньшее (следующее по величине) значение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j">, для которого выполняется префикс-свойство, и так далее. Может случиться, что такие значения <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j"> кончатся — это происходит, когда <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/6387a5f530ac2306cd6c3a6be974de34.png" alt="j=0">. В этом случае, если <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f4bafdd61a5352ca7a26cce763eda871.png" alt="s[i+1]=s[0]">, то <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/eb69187bfe3a3565c921142b6f4f05bf.png" alt="\pi[i+1]=1">, иначе <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/7cac24d8103b187bd5ef516822d02e2e.png" alt="\pi[i+1]=0">.</p><p>Итак, общая схема алгоритма у нас уже есть, нерешённым остался только вопрос об эффективном нахождении таких длин <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j">. Поставим этот вопрос формально: по текущей длине <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j"> и позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> (для которых выполняется префикс-свойство, т.е. <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/35b64062a499937e5bb8da72d9f74232.png" alt="s[0 \ldots j-1] = s[i-j+1 \ldots i]">) требуется найти наибольшее <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/477871ef0cea8b58957280215a252a9a.png" alt="k &lt; j">, для которого по-прежнему выполняется префикс-свойство:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d5ebca93cfea52f90c08ebf584c35d20.png" alt=" \overbrace{\underbrace{s_0 \ s_1}_{k} \ s_2 \ s_3[...]"></p><p>После столь подробного описания уже практически напрашивается, что это значение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k"> есть не что иное, как значение префикс-функции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/5d1671356ad5398eb379682698198f41.png" alt="\pi[j-1]">, которое уже было вычислено нами ранее (вычитание единицы появляется из-за 0-индексации строк). Таким образом, находить эти длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k"> мы можем за <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/817532dd84d4eb666e5d80dc58098e94.png" alt="O(1)"> каждую.</p><p></p><a name="6"></a><h3 style="padding-top:15px;" id="header_6"> Итоговый алгоритм </h3><p>Итак, мы окончательно построили алгоритм, который не содержит явных сравнений строк и выполняет <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/3bd5ae6ef1beefce202e062967bc49c1.png" alt="O(n)"> действий.</p><p>Приведём здесь итоговую схему алгоритма:</p><p></p><ul><p></p><li>Считать значения префикс-функции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]"> будем по очереди: от <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f139289eb1f84cc9579e92a95127828f.png" alt="i=1"> к <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/31263c41a17092cf70b403d97f4916ee.png" alt="i=n-1"> (значение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/315323d7df41ef0fa08b8c392acc2bd8.png" alt="\pi[0]"> просто присвоим равным нулю).<p></p></li><li>Для подсчёта текущего значения <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]"> мы заводим переменную <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j">, обозначающую длину текущего рассматриваемого образца. Изначально <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/5eb0e9dc98766785be41f6dbadf6e993.png" alt="j = \pi[i-1]">.<p></p></li><li>Тестируем образец длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j">, для чего сравниваем символы <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/6989ece3ad295d18904612384b74598e.png" alt="s[j]"> и <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/fd6f470cea3a6f4a8e40703f1a939deb.png" alt="s[i]">. Если они совпадают — то полагаем <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/9bb351ebd7f8d16425771ded88d91730.png" alt="\pi[i] = j+1"> и переходим к следующему индексу <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/4ec332d2c63d7695c3b676e8e6dd9881.png" alt="i+1">. Если же символы отличаются, то уменьшаем длину <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j">, полагая её равной <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/5d1671356ad5398eb379682698198f41.png" alt="\pi[j-1]">, и повторяем этот шаг алгоритма с начала.<p></p></li><li>Если мы дошли до длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/6387a5f530ac2306cd6c3a6be974de34.png" alt="j=0"> и так и не нашли совпадения, то останавливаем процесс перебора образцов и полагаем <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/0d1b7576f4ce2bd3716e0e2ece86922e.png" alt="\pi[i] = 0"> и переходим к следующему индексу <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/4ec332d2c63d7695c3b676e8e6dd9881.png" alt="i+1">.</li></ul><p></p><a name="7"></a><h3 style="padding-top:15px;" id="header_7"> Реализация </h3><p>Алгоритм в итоге получился удивительно простым и лаконичным:</p><p></p><pre class="notranslate cpp">vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> prefix_function <span class="br0">(</span>string s<span class="br0">)</span> <span class="br0">{</span>
	<span class="kw4">int</span> n <span class="sy1">=</span> <span class="br0">(</span><span class="kw4">int</span><span class="br0">)</span> s.<span class="me1">length</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
	vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> pi <span class="br0">(</span>n<span class="br0">)</span><span class="sy4">;</span>
	<span class="kw1">for</span> <span class="br0">(</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">1</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>n<span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">)</span> <span class="br0">{</span>
		<span class="kw4">int</span> j <span class="sy1">=</span> pi<span class="br0">[</span>i<span class="sy2">-</span><span class="nu0">1</span><span class="br0">]</span><span class="sy4">;</span>
		<span class="kw1">while</span> <span class="br0">(</span>j <span class="sy1">&gt;</span> <span class="nu0">0</span> <span class="sy3">&amp;&amp;</span> s<span class="br0">[</span>i<span class="br0">]</span> <span class="sy3">!</span><span class="sy1">=</span> s<span class="br0">[</span>j<span class="br0">]</span><span class="br0">)</span>
			j <span class="sy1">=</span> pi<span class="br0">[</span>j<span class="sy2">-</span><span class="nu0">1</span><span class="br0">]</span><span class="sy4">;</span>
		<span class="kw1">if</span> <span class="br0">(</span>s<span class="br0">[</span>i<span class="br0">]</span> <span class="sy1">==</span> s<span class="br0">[</span>j<span class="br0">]</span><span class="br0">)</span>  <span class="sy2">++</span>j<span class="sy4">;</span>
		pi<span class="br0">[</span>i<span class="br0">]</span> <span class="sy1">=</span> j<span class="sy4">;</span>
	<span class="br0">}</span>
	<span class="kw1">return</span> pi<span class="sy4">;</span>
<span class="br0">}</span></pre><p>Как нетрудно заметить, этот алгоритм является <b>онлайновым</b> алгоритмом, т.е. он обрабатывает данные по ходу поступления — можно, например, считывать строку по одному символу и сразу обрабатывать этот символ, находя ответ для очередной позиции. Алгоритм требует хранения самой строки и предыдущих вычисленных значений префикс-функции, однако, как нетрудно заметить, если нам заранее известно максимальное значение, которое может принимать префикс-функция на всей строке, то достаточно будет хранить лишь на единицу большее количество первых символов строки и значений префикс-функции.</p><p></p><p></p><a name="8"></a><h2 style="padding-top:40px;" id="header_8"> Применения </h2><p></p><p></p><a name="9"></a><h3 style="padding-top:15px;" id="header_9"> Поиск подстроки в строке. Алгоритм Кнута-Морриса-Пратта </h3><p>Эта задача является классическим применением префикс-функции (и, собственно, она и была открыта в связи с этим).</p><p>Дан текст <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> и строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s">, требуется найти и вывести позиции всех вхождений строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> в текст <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">.</p><p>Обозначим для удобства через <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> длину строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s">, а через <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/4f70748eaed5e0c2c70d7e899166ee1d.png" alt="m"> — длину текста <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">.</p><p>Образуем строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/223ada77513bdb4a3961bf90b53367d3.png" alt="s + \# + t">, где символ <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/ae8bd1a2f7031a30fb5176b2281ac12a.png" alt="\#"> — это разделитель, который не должен нигде более встречаться. Посчитаем для этой строки префикс-функцию. Теперь рассмотрим её значения, кроме первых <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/a7f8de3dd9b0da0eb8ed96689169566e.png" alt="n+1"> (которые, как видно, относятся к строке <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> и разделителю). По определению, значение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]"> показывает наидлиннейшую длину подстроки, оканчивающейся в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> и совпадающего с префиксом. Но в нашем случае это <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]"> — фактически длина наибольшего блока совпадения со строкой <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> и оканчивающегося в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i">. Больше, чем <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">, эта длина быть не может — за счёт разделителя. А вот равенство <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/08b0696811b7ef5441355a57a45f413e.png" alt="\pi[i] = n"> (там, где оно достигается), означает, что в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> оканчивается искомое вхождение строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> (только не надо забывать, что все позиции отсчитываются в склеенной строке <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d4aa5334270839eff4478152eba7e3f5.png" alt="s+\#+t">).</p><p>Таким образом, если в какой-то позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> оказалось <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/08b0696811b7ef5441355a57a45f413e.png" alt="\pi[i] = n">, то в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/6c4a92029637777a5e23df79aa1dea70.png" alt="i - (n + 1) - n + 1 = i - 2 n"> строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> начинается очередное вхождение строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> в строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">.</p><p>Как уже упоминалось при описании алгоритма вычисления префикс-функции, если известно, что значения префикс-функции не будут превышать некоторой величины, то достаточно хранить не всю строку и префикс-функцию, а только её начало. В нашем случае это означает, что нужно хранить в памяти лишь строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/05987a5029b6133da075f8a5582128a4.png" alt="s + \#"> и значение префикс-функции на ней, а потом уже считывать по одному символу строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> и пересчитывать текущее значение префикс-функции.</p><p>Итак, алгоритм Кнута-Морриса-Пратта решает эту задачу за <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d20d4ea468976eeb83adea753c1fd674.png" alt="O(n+m)"> времени и <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/3bd5ae6ef1beefce202e062967bc49c1.png" alt="O(n)"> памяти.</p><p></p><p></p><a name="10"></a><h3 style="padding-top:15px;" id="header_10"> Подсчёт числа вхождений каждого префикса </h3><p>Здесь мы рассмотрим сразу две задачи. Дана строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">. В первом варианте требуется для каждого префикса <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/495fda7ff891ae7a249da7300ded14c8.png" alt="s[0 \ldots i]"> посчитать, сколько раз он встречается в самой же строке <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s">. Во втором варианте задачи дана другая строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">, и требуется для каждого префикса <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/495fda7ff891ae7a249da7300ded14c8.png" alt="s[0 \ldots i]"> посчитать, сколько раз он встречается в <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">.</p><p>Решим сначала первую задачу. Рассмотрим в какой-либо позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> значение префикс-функции в ней <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]">. По определению, оно означает, что в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> оканчивается вхождение префикса строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]">, и никакой больший префикс оканчиваться в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> не может. В то же время, в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> могло оканчиваться и вхождение префиксов меньших длин (и, очевидно, совсем не обязательно длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/7ad0684f13912695ac27cd81d8fd31bc.png" alt="\pi[i]-1">). Однако, как нетрудно заметить, мы пришли к тому же вопросу, на который мы уже отвечали при рассмотрении алгоритма вычисления префикс-функции: по данной длине <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j"> надо сказать, какой наидлиннейший её собственный суффикс совпадает с её префиксом. Мы уже выяснили, что ответом на этот вопрос будет <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/5d1671356ad5398eb379682698198f41.png" alt="\pi[j-1]">. Но тогда и в этой задаче, если в позиции <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> оканчивается вхождение подстроки длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]">, совпадающей с префиксом, то в <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> также оканчивается вхождение подстроки длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d442ac0241072accdaaf5156b02ff6d0.png" alt="\pi[\pi[i]-1]">, совпадающей с префиксом, а для неё применимы те же рассуждения, поэтому в <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> также оканчивается и вхождение длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/b6c526e445d02558364a1a88962240d5.png" alt="\pi[\pi[\pi[i]-1]-1]"> и так далее (пока индекс не станет нулевым). Таким образом, для вычисления ответа мы должны выполнить такой цикл:</p><p></p><pre class="notranslate cpp">vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> ans <span class="br0">(</span>n<span class="sy2">+</span><span class="nu0">1</span><span class="br0">)</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">(</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>n<span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">)</span>
	<span class="sy2">++</span>ans<span class="br0">[</span>pi<span class="br0">[</span>i<span class="br0">]</span><span class="br0">]</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">(</span><span class="kw4">int</span> i<span class="sy1">=</span>n<span class="sy2">-</span><span class="nu0">1</span><span class="sy4">;</span> i<span class="sy1">&gt;</span><span class="nu0">0</span><span class="sy4">;</span> <span class="sy2">--</span>i<span class="br0">)</span>
	ans<span class="br0">[</span>pi<span class="br0">[</span>i<span class="sy2">-</span><span class="nu0">1</span><span class="br0">]</span><span class="br0">]</span> <span class="sy2">+</span><span class="sy1">=</span> ans<span class="br0">[</span>i<span class="br0">]</span><span class="sy4">;</span></pre><p>Здесь мы для каждого значения префикс-функции сначала посчитали, сколько раз он встречался в массиве <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/a106b4d8d7bcc0276db35515f33a5ad0.png" alt="\pi[]">, а затем посчитали такую в некотором роде динамику: если мы знаем, что префикс длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> встречался ровно <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d201a75a0914a39406c45b955ab0eab6.png" alt="{\rm ans}[i]"> раз, то именно такое количество надо прибавить к числу вхождений его длиннейшего собственного суффикса, совпадающего с его префиксом; затем уже из этого суффикса (конечно, меньшей чем <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> длины) выполнится "пробрасывание" этого количества к своему суффиксу, и т.д.</p><p>Теперь рассмотрим вторую задачу. Применим стандартный приём: припишем к строке <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> через разделитель, т.е. получим строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d4aa5334270839eff4478152eba7e3f5.png" alt="s+\#+t">, и посчитаем для неё префикс-функцию. Единственное отличие от первой задачи будет в том, что учитывать надо только те значения префикс-функции, которые относятся к строке <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">, т.е. все <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d0882981c78ba1cbefb287fe60a0aeed.png" alt="\pi[i]"> для <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d6e773ab74e29eb2fe158540da60c3ce.png" alt="i \ge n+1">.</p><p></p><p></p><a name="11"></a><h3 style="padding-top:15px;" id="header_11"> Количество различных подстрок в строке </h3><p>Дана строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">. Требуется посчитать количество её различных подстрок.</p><p>Будем решать эту задачу итеративно. А именно, научимся, зная текущее количество различных подстрок, пересчитывать это количество при добавлении в конец одного символа.</p><p>Итак, пусть <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k"> — текущее количество различных подстрок строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s">, и мы добавляем в конец символ <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/fdabaa70e1c423d289836bd4624e9e4e.png" alt="c">. Очевидно, в результате могли появиться некоторые новые подстроки, оканчивавшиеся на этом новом символе <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/fdabaa70e1c423d289836bd4624e9e4e.png" alt="c">. А именно, добавляются в качестве новых те подстроки, оканчивающиеся на символе <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/fdabaa70e1c423d289836bd4624e9e4e.png" alt="c"> и не встречавшиеся ранее.</p><p>Возьмём строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/88b5dbd73e8ec9bd9d8da4b46fdf3d14.png" alt="t = s + c"> и инвертируем её (запишем символы в обратном порядке). Наша задача — посчитать, сколько у строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> таких префиксов, которые не встречаются в ней более нигде. Но если мы посчитаем для строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> префикс-функцию и найдём её максимальное значение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/bbd07e441752b3cbf91328c048a06454.png" alt="\pi_{\rm max}">, то, очевидно, в строке <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> встречается (не в начале) её префикс длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/bbd07e441752b3cbf91328c048a06454.png" alt="\pi_{\rm max}">, но не большей длины. Понятно, префиксы меньшей длины уж точно встречаются в ней.</p><p>Итак, мы получили, что число новых подстрок, появляющихся при дописывании символа <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/fdabaa70e1c423d289836bd4624e9e4e.png" alt="c">, равно <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/16e2003177e083c43285c781f711b3a5.png" alt="s.{\rm length}() + 1 - \pi_{\rm max}">.</p><p>Таким образом, для каждого дописываемого символа мы за <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/3bd5ae6ef1beefce202e062967bc49c1.png" alt="O(n)"> можем пересчитать количество различных подстрок строки. Следовательно, за <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/712c5a4a9bec3c435e92314194c99f95.png" alt="O(n^2)"> мы можем найти количество различных подстрок для любой заданной строки.</p><p>Стоит заметить, что совершенно аналогично можно пересчитывать количество различных подстрок и при дописывании символа в начало, а также при удалении символа с конца или с начала.</p><p></p><p></p><a name="12"></a><h3 style="padding-top:15px;" id="header_12"> Сжатие строки </h3><p>Дана строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">. Требуется найти самое короткое её "сжатое" представление, т.е. найти такую строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> наименьшей длины, что <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> можно представить в виде конкатенации одной или нескольких копий <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">.</p><p>Понятно, что проблема является в нахождении длины искомой строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">. Зная длину, ответом на задачу будет, например, префикс строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> этой длины.</p><p>Посчитаем по строке <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> префикс-функцию. Рассмотрим её последнее значение, т.е. <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/9635dd1b719edbdd4fc22e22c691622f.png" alt="\pi[n-1]">, и введём обозначение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8b0f267048be875b1740c568bd177850.png" alt="k = n - \pi[n-1]">. Покажем, что если <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> делится на <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k">, то это <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k"> и будет длиной ответа, иначе эффективного сжатия не существует, и ответ равен <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">.</p><p>Действительно, пусть <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> делится на <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k">. Тогда строку можно представить в виде нескольких блоков длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k">, причём, по определению префикс-функции, префикс длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/c682e08745ff5014220a3cf23953366c.png" alt="n-k"> будет совпадать с её суффиксом. Но тогда последний блок должен будет совпадать с предпоследним, предпоследний - с предпредпоследним, и т.д. В итоге получится, что все блоки блоки совпадают, и такое <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k"> действительно подходит под ответ.</p><p>Покажем, что этот ответ оптимален. Действительно, в противном случае, если бы нашлось меньшее <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k">, то и префикс-функция на конце была бы больше, чем <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/c682e08745ff5014220a3cf23953366c.png" alt="n-k">, т.е. пришли к противоречию.</p><p>Пусть теперь <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n"> не делится на <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k">. Покажем, что отсюда следует, что длина ответа равна <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">. Докажем от противного — предположим, что ответ существует, и имеет длину <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2f8934466bea85c9661745280df23800.png" alt="p"> (<img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2f8934466bea85c9661745280df23800.png" alt="p"> делитель <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">). Заметим, что префикс-функция необходимо должна быть больше <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/0bb2f258471a06696746a9abe3adfec3.png" alt="n - p">, т.е. этот суффикс должен частично накрывать первый блок. Теперь рассмотрим второй блок строки; т.к. префикс совпадает с суффиксом, и и префикс, и суффикс покрывают этот блок, и их смещение друг относительно друга <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k"> не делит длину блока <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2f8934466bea85c9661745280df23800.png" alt="p"> (а иначе бы <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k"> делило <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bc19c5640342f9c5ad0ba16baf59981.png" alt="n">), то все символы блока совпадают. Но тогда строка состоит из одного и того же символа, отсюда <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/c52bf046f58b7dd5434e50c9358055d3.png" alt="k=1">, и ответ должен существовать, т.е. так мы придём к противоречию.</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/bdcc84899eed4198d223bc5a3d59b38a.png" alt=" \overbrace{s_0\ s_1\ s_2\ s_3}^{p}\ \overbrace{s_[...]"><br><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/85df6079812ccb82f5ee75d15b5fc24a.png" alt=" s_0\ s_1\ s_2\ \underbrace{\overbrace{s_3\ s_4\ s[...]"><br><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/db4c12bd93354e1ca8359fbf96314143.png" alt=" s_4=s_3,\ \ s_5=s_4,\ \ s_6=s_5,\ \ s_7=s_6\ \ \ [...]"></p><p></p><p></p><a name="13"></a><h3 style="padding-top:15px;" id="header_13"> Построение автомата по префикс-функции </h3><p>Вернёмся к уже неоднократно использованному приёму конкатенации двух строк через разделитель, т.е. для данных строк <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> и <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> вычисление префикс-функции для строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d4aa5334270839eff4478152eba7e3f5.png" alt="s+\#+t">. Очевидно, что т.к. символ <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/ae8bd1a2f7031a30fb5176b2281ac12a.png" alt="\#"> является разделителем, то значение префикс-функции никогда не превысит <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8432e33e9a08a5d53aa7bb45cb2f5559.png" alt="s.{\rm length}()">. Отсюда следует, что, как упоминалось при описании алгоритма вычисления префикс-функции, достаточно хранить только строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/3d057cd85f25d9c587c4a05be889d879.png" alt="s+\#"> и значения префикс-функции для неё, а для всех последующих символов префикс-функцию вычислять на лету:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/b50be6a59e32df5bbb401fc8fb7db2c9.png" alt=" \underbrace{s_0\ s_1\ \ldots\ s_{n-1}\ \#}_{\rm n[...]"></p><p>Действительно, в такой ситуации, зная очередной символ <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/15922a5325e543dae2e38544190bce60.png" alt="c \in t"> и значение префикс-функции в предыдущей позиции, можно будет вычислить новое значение префикс-функции, никак при этом не используя все предыдущие символы строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> и значения префикс-функции в них.</p><p>Другими словами, мы можем построить <b>автомат</b>: состоянием в нём будет текущее значение префикс-функции, переходы из одного состояния в другое будут осуществляться под действием символа:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8d0a85e14c1ef5d4387672101aa0e6a7.png" alt=" s_0\ s_1\ \ldots\ s_{n-1}\ \# \underbrace{\ldots}[...]"></p><p>Таким образом, даже ещё не имея строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">, мы можем предварительно построить такую таблицу переходов <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/e0056d44606eddbcdbcfcfe9f9cb7495.png" alt="({\rm old}\_\pi,c) \rightarrow {\rm new}\_\pi"> с помощью того же алгоритма вычисления префикс-функции:</p><p></p><pre class="notranslate cpp">string s<span class="sy4">;</span> <span class="co1">// входная строка</span>
<span class="kw4">const</span> <span class="kw4">int</span> alphabet <span class="sy1">=</span> <span class="nu0">256</span><span class="sy4">;</span> <span class="co1">// мощность алфавита символов, обычно меньше</span>
&nbsp;
s <span class="sy2">+</span><span class="sy1">=</span> <span class="st0">'#'</span><span class="sy4">;</span>
<span class="kw4">int</span> n <span class="sy1">=</span> <span class="br0">(</span><span class="kw4">int</span><span class="br0">)</span> s.<span class="me1">length</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> pi <span class="sy1">=</span> prefix_function <span class="br0">(</span>s<span class="br0">)</span><span class="sy4">;</span>
vector <span class="sy1">&lt;</span> vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> <span class="sy1">&gt;</span> aut <span class="br0">(</span>n, vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> <span class="br0">(</span>alphabet<span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">(</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>n<span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">)</span>
	<span class="kw1">for</span> <span class="br0">(</span><span class="kw4">char</span> c<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> c<span class="sy1">&lt;</span>alphabet<span class="sy4">;</span> <span class="sy2">++</span>c<span class="br0">)</span> <span class="br0">{</span>
		<span class="kw4">int</span> j <span class="sy1">=</span> i<span class="sy4">;</span>
		<span class="kw1">while</span> <span class="br0">(</span>j <span class="sy1">&gt;</span> <span class="nu0">0</span> <span class="sy3">&amp;&amp;</span> c <span class="sy3">!</span><span class="sy1">=</span> s<span class="br0">[</span>j<span class="br0">]</span><span class="br0">)</span>
			j <span class="sy1">=</span> pi<span class="br0">[</span>j<span class="sy2">-</span><span class="nu0">1</span><span class="br0">]</span><span class="sy4">;</span>
		<span class="kw1">if</span> <span class="br0">(</span>c <span class="sy1">==</span> s<span class="br0">[</span>j<span class="br0">]</span><span class="br0">)</span>  <span class="sy2">++</span>j<span class="sy4">;</span>
		aut<span class="br0">[</span>i<span class="br0">]</span><span class="br0">[</span>c<span class="br0">]</span> <span class="sy1">=</span> j<span class="sy4">;</span>
	<span class="br0">}</span></pre><p>Правда, в таком виде алгоритм будет работать за <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/7807cd70296b2bd8eb0a40f650000b84.png" alt="O(n^2 k)"> (<img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k"> — мощность алфавита). Но заметим, что вместо внутреннего цикла <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d5788ebb507c45e342eabc412e75d049.png" alt="\rm while">, который постепенно укорачивает ответ, мы можем воспользоваться уже вычисленной частью таблицы: переходя от значения <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j"> к значению <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/5d1671356ad5398eb379682698198f41.png" alt="\pi[j-1]">, мы фактически говорим, что переход из состояния <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f0a868ffdddf0eaeb5ecf3ff35d9cdb5.png" alt="(j, c)"> приведёт в то же состояние, что и переход <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/bf884859715aa9fe67cad5d34b6c414e.png" alt="(\pi[j-1], c)">, а для него ответ уже точно посчитан (т.к. <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/11a7a2ae36ceb167071f1f43af25fb8d.png" alt="\pi[j-1] &lt; j">):</p><p></p><pre class="notranslate cpp">string s<span class="sy4">;</span> <span class="co1">// входная строка</span>
<span class="kw4">const</span> <span class="kw4">int</span> alphabet <span class="sy1">=</span> <span class="nu0">256</span><span class="sy4">;</span> <span class="co1">// мощность алфавита символов, обычно меньше</span>
&nbsp;
s <span class="sy2">+</span><span class="sy1">=</span> <span class="st0">'#'</span><span class="sy4">;</span>
<span class="kw4">int</span> n <span class="sy1">=</span> <span class="br0">(</span><span class="kw4">int</span><span class="br0">)</span> s.<span class="me1">length</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> pi <span class="sy1">=</span> prefix_function <span class="br0">(</span>s<span class="br0">)</span><span class="sy4">;</span>
vector <span class="sy1">&lt;</span> vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> <span class="sy1">&gt;</span> aut <span class="br0">(</span>n, vector<span class="sy1">&lt;</span><span class="kw4">int</span><span class="sy1">&gt;</span> <span class="br0">(</span>alphabet<span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
<span class="kw1">for</span> <span class="br0">(</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> i<span class="sy1">&lt;</span>n<span class="sy4">;</span> <span class="sy2">++</span>i<span class="br0">)</span>
	<span class="kw1">for</span> <span class="br0">(</span><span class="kw4">char</span> c<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span> c<span class="sy1">&lt;</span>alphabet<span class="sy4">;</span> <span class="sy2">++</span>c<span class="br0">)</span>
		<span class="kw1">if</span> <span class="br0">(</span>i <span class="sy1">&gt;</span> <span class="nu0">0</span> <span class="sy3">&amp;&amp;</span> c <span class="sy3">!</span><span class="sy1">=</span> s<span class="br0">[</span>i<span class="br0">]</span><span class="br0">)</span>
			aut<span class="br0">[</span>i<span class="br0">]</span><span class="br0">[</span>c<span class="br0">]</span> <span class="sy1">=</span> aut<span class="br0">[</span>pi<span class="br0">[</span>i<span class="sy2">-</span><span class="nu0">1</span><span class="br0">]</span><span class="br0">]</span><span class="br0">[</span>c<span class="br0">]</span><span class="sy4">;</span>
		<span class="kw1">else</span>
			aut<span class="br0">[</span>i<span class="br0">]</span><span class="br0">[</span>c<span class="br0">]</span> <span class="sy1">=</span> i <span class="sy2">+</span> <span class="br0">(</span>c <span class="sy1">==</span> s<span class="br0">[</span>i<span class="br0">]</span><span class="br0">)</span><span class="sy4">;</span></pre><p>В итоге получилась крайне простая реализация построения автомата, работающая за <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/890d35c28916af6a7af779c7befbfb9e.png" alt="O(n k)">.</p><p>Когда может быть полезен такой автомат? Для начала вспомним, что мы считаем префикс-функцию для строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d4aa5334270839eff4478152eba7e3f5.png" alt="s+\#+t">, и её значения обычно используют с единственной целью: найти все вхождения строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> в строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t">.</p><p>Поэтому самая очевидная польза от построения такого автомата — <b>ускорение вычисления префикс-функции</b> для строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/d4aa5334270839eff4478152eba7e3f5.png" alt="s+\#+t">. Построив по строке <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/3d057cd85f25d9c587c4a05be889d879.png" alt="s+\#"> автомат, нам уже больше не нужна ни строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s">, ни значения префикс-функции в ней, не нужны и никакие вычисления — все переходы (т.е. то, как будет меняться префикс-функция) уже предпосчитаны в таблице.</p><p>Но есть и второе, менее очевидное применение. Это случай, когда строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> <b>является гигантской строкой, построенной по какому-либо правилу</b>. Это может быть, например, строка Грея или строка, образованная рекурсивной комбинацией нескольких коротких строк, поданных на вход.</p><p>Пусть для определённости мы решаем <b>такую задачу</b>: дан номер <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/55aebdd2f4d2c8b8d1b8ecddb0e36c5a.png" alt="k \le 10^5"> строки Грея, и дана строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> длины <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/6f58b89c85c3d5eae8b750695be82ea9.png" alt="n \le 10^5">. Требуется посчитать количество вхождений строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> в <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k">-ю строку Грея. Напомним, строки Грея определяются таким образом:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f9b708cb4c77c529f22938f72399a903.png" alt=" g_1 = " a"="" "=""><br><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/51beaaa8eba626fe00c3fdd9a577d0c0.png" alt=" g_2 = " aba"="" "=""><br><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/9a95388799fb9f7c1b29a42f7cde54fb.png" alt=" g_3 = " abacaba"="" "=""><br><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/9c0e996f2b62436d59ce1ccd1ec95ccd.png" alt=" g_4 = " abacabadabacaba"="" "=""><br><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/3ee865b5cc661e7f1c429bc56246d9cf.png" alt=" \ldots "></p><p>В таких случаях даже просто построение строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/668c0ed766381807a81b9a534a4a70ce.png" alt="t"> будет невозможным из-за её астрономической длины (например, <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/252410059470b019db6fd4c3b844a348.png" alt="k">-ая строка Грея имеет длину <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/b178483be9d0a6dd4827cc216bef07c8.png" alt="2^k-1">). Тем не менее, мы сможем посчитать значение префикс-функции на конце этой строки, зная значение префикс-функции, которое было перед началом этой строки.</p><p>Итак, помимо самого автомата также посчитаем такие величины: <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/e20c4eddf9f6d07a3975c2fa08d30b6d.png" alt="G[i][j]"> — значение автомата, достигаемое после "скармливания" ему строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/01bfe703fcd356724c90c91209904c97.png" alt="g_i">, если до этого автомат находился в состоянии <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j">. Вторая величина — <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/9474368ea7ddb534c9139b31cffc614a.png" alt="K[i][j]"> — количество вхождений строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> в строку <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/01bfe703fcd356724c90c91209904c97.png" alt="g_i">, если до "скармливания" этой строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/01bfe703fcd356724c90c91209904c97.png" alt="g_i"> автомат находился в состоянии <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/f2761432c5377ee4ded848884be6d407.png" alt="j">. Фактически, <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/9474368ea7ddb534c9139b31cffc614a.png" alt="K[i][j]"> — это количество раз, которое автомат принимал значение <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8432e33e9a08a5d53aa7bb45cb2f5559.png" alt="s.{\rm length}()"> за время "скармливания" строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/01bfe703fcd356724c90c91209904c97.png" alt="g_i">. Понятно, что ответом на задачу будет величина <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8fbeb4142d468b3b8799780d4b14022e.png" alt="K[k][0]">.</p><p>Как считать эти величины? Во-первых, базовыми значениями являются <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/dd5b0c9107e88b1581946764562a93ee.png" alt="G[0][j] = j">, <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/6a5877104b6f4e828e002963e245cfa7.png" alt="K[0][j] = 0">. А все последующие значения можно вычислять по предыдущим значениям и используя автомат. Итак, для вычисления этих значений для некоторого <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i"> мы вспоминаем, что строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/01bfe703fcd356724c90c91209904c97.png" alt="g_i"> состоит из <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/27a8c68865c5a946cf4e01ad55eb54fa.png" alt="g_{i-1}"> плюс <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/2d9d1096e116db33bc39a0accf4e9ef7.png" alt="i">-ый символ алфавита плюс снова <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/27a8c68865c5a946cf4e01ad55eb54fa.png" alt="g_{i-1}">. Тогда после "скармливания" первого куска (<img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/27a8c68865c5a946cf4e01ad55eb54fa.png" alt="g_{i-1}">) автомат перейдёт в состояние <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/71e2dc687f81a4d23474902bd97110e3.png" alt="G[i-1][j]">, затем после "скармливания" символа <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/a76efdfa3e6ec5196175bfbd0d88a8d2.png" alt="{\rm char}_i"> он перейдёт в состояние:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/699981dd6e4d62e9d848c0ff123c3fa8.png" alt=" {\rm mid} = {\rm aut}[\ G[i-1][j]\ ][{\rm char}_i[...]"></p><p>После этого автомату "скармливается" последний кусок, т.е. <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/27a8c68865c5a946cf4e01ad55eb54fa.png" alt="g_{i-1}">:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/8bbc84b6c90851219d45e3aeca53c489.png" alt=" G[i][j] = G[i-1][{\rm mid}] "></p><p>Количества <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/9474368ea7ddb534c9139b31cffc614a.png" alt="K[i][j]"> легко считаются как сумма количеств по трём кускам <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/01bfe703fcd356724c90c91209904c97.png" alt="g_i">: строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/27a8c68865c5a946cf4e01ad55eb54fa.png" alt="g_{i-1}">, символ <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/a76efdfa3e6ec5196175bfbd0d88a8d2.png" alt="{\rm char}_i">, и снова строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/27a8c68865c5a946cf4e01ad55eb54fa.png" alt="g_{i-1}">:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/3fa82586b7b3128d1fda79c633ef67ef.png" alt=" K[i][j] = K[i-1][j] + ({\rm mid} == s.{\rm length[...]"></p><p>Итак, мы решили задачу для строк Грея, аналогично можно решить целый класс таких задач. Например, точно таким же методом решается <b>следующая задача</b>: дана строка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s">, и образцы <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/724b75c9890da9892c0220dff280997d.png" alt="t_i">, каждый из которых задаётся следующим образом: это строка из обычных символов, среди которых могут встречаться рекурсивные вставки других строк в форме <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/16178f45543a3631c58439e195ab1fd2.png" alt="t_k[\rm cnt]">, которая означает, что в это место должно быть вставлено <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/131aab58e5e6cb4c3f04eaf6ab286002.png" alt="\rm cnt"> экземпляров строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/6922cd1d5d461063634b2c548ee51b4c.png" alt="t_k">. Пример такой схемы:</p><p></p><p class="formula"><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/4f90074cfd495f5fd8a406bf8fb7ef22.png" alt=" t_1 = " abdeca"="" "=""><br><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/b6bd9e76284efd0fed0bfcc7b40abdeb.png" alt=" t_2 = " abc"="" +="" t_1[30]="" "abd"="" "=""><br><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/18df5771b6b8ed82a51499b1007c9efb.png" alt=" t_3 = t_2[50] + t_1[100] "><br><img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/301e309a92d850b93614514174258f6a.png" alt=" t_4 = t_2[10] + t_3[100] "></p><p>Гарантируется, что это описание не содержит в себе циклических зависимостей. Ограничения таковы, что если явным образом раскрывать рекурсию и находить строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/724b75c9890da9892c0220dff280997d.png" alt="t_i">, то их длины могут достигать порядка <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/9c3c181c0ca67feaf22c235bfb860ec9.png" alt="100^{100}">.</p><p>Требуется найти количество вхождений строки <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/342d607718e99ee38ba275df55ced44e.png" alt="s"> в каждую из строк <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/724b75c9890da9892c0220dff280997d.png" alt="t_i">.</p><p>Задача решается так же, построением автомата префикс-функции, затем надо вычислять и добавлять в него переходы по целым строкам <img class="tex" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/724b75c9890da9892c0220dff280997d.png" alt="t_i">. В общем-то, это просто более общий случай по сравнению с задачей о строках Грея.</p><p></p><p></p><a name="14"></a><h2 style="padding-top:40px;" id="header_14"> Задачи в online judges </h2><p>Список задач, которые можно решить, используя префикс-функцию:</p><p></p><ul><p></p><li><a href="http://uva.onlinejudge.org/index.php?option=onlinejudge&page=show_problem&problem=396">UVA #455 <b>"Periodic Strings"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p></p></li><li><a href="http://uva.onlinejudge.org/index.php?option=onlinejudge&page=show_problem&problem=1963">UVA #11022 <b>"String Factoring"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p></p></li><li><a href="http://uva.onlinejudge.org/index.php?option=onlinejudge&page=show_problem&problem=2447">UVA #11452 <b>"Dancing the Cheeky-Cheeky"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: средняя]</a><p></p></li><li><a href="http://acm.sgu.ru/problem.php?contest=0&problem=284">SGU #284 <b>"Grammar"</b> &nbsp;&nbsp;&nbsp;&nbsp; [сложность: высокая]</a><p></p></li></ul><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><hr><p>
</p><div id="disqus_thread"><iframe id="dsq-1" data-disqus-uid="1" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./MAXimal __ algo __ Префикс-функция. Алгоритм Кнута-Морриса-Пратта_files/saved_resource.html" style="width: 100% !important; border: none !important; overflow: hidden !important; height: 2640px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
<script type="text/javascript">
    var disqus_shortname = 'e-maxx';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script></td></tr></tbody></table></body></html>